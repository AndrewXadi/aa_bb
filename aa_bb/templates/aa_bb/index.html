{% extends 'aa_bb/base.html' %}
{% load i18n %}
{% load humanize %}

{% block details %}

<!-- Dropdown -->
<div class="mb-4">
  <label for="pageDropdown">{% translate "Select Account" %}</label>
  <select id="pageDropdown" class="form-control">
    <option value="" disabled selected>-- Choose an account --</option>
    {% for option in dropdown_options %}
      <option value="{{ option }}">{{ option }}</option>
    {% endfor %}
  </select>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="text-center mb-4" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="sr-only">Loading...</span>
  </div>
</div>

<!-- Error / Info Message -->
<div id="messageBox" class="alert" style="display: none;"></div>
<div id="contractMessage" class="alert" style="display:none;"></div>
<div id="errorMessages"></div>

<!-- Cards Container -->
<div id="cardsContainer"></div>

{% endblock %}

{% block extra_javascript %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const CARD_DEFINITIONS = [
    {% for card in CARD_DEFINITIONS %}
      { title: `{{ card.title|escapejs }}`, key: `{{ card.key }}` }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  const dropdown         = document.getElementById('pageDropdown');
  const container        = document.getElementById('cardsContainer');
  const spinner          = document.getElementById('loadingSpinner');
  const generalMessage   = document.getElementById('messageBox');
  const contractMessage  = document.getElementById('contractMessage');  // second box
  const errorMessages    = document.getElementById('errorMessages');
  const MAIL_KEYWORDS = {{ MAIL_KEYWORDS|default:"[]" }};
  const MAIL_VISIBLE = [
    "sent_date", "subject",
    "sender_name", "sender_corporation", "sender_alliance",
    "recipient_names", "recipient_corps", "recipient_alliances", "status"
  ];
  const TOTAL_CARDS      = CARD_DEFINITIONS.length;
  const SUS_CONTR_KEY    = 'sus_contr';
  let loadedNonSus       = 0;

  function showSpinner(on) {
    spinner.style.display = on ? 'block' : 'none';
  }
  function showGeneral(msg, type='info') {
    generalMessage.innerHTML    = msg;
    generalMessage.className    = 'alert alert-' + type;
    generalMessage.style.display = 'block';
  }
  function hideGeneral() {
    generalMessage.style.display = 'none';
  }
  function showContract(msg, type='info') {
    contractMessage.innerHTML    = msg;
    contractMessage.className    = 'alert alert-' + type;
    contractMessage.style.display = 'block';
  }
  function hideContract() {
    contractMessage.style.display = 'none';
  }

  function renderCard(idx, title, content, status) {
    const collapseId = `collapse${idx}`;
    const icon = status
      ? '<span class="text-success">&#128994;</span>'
      : '<span class="text-danger">&#128681;</span>';
    const cardDiv = document.createElement('div');
    cardDiv.className = 'card mb-2';
    cardDiv.innerHTML = `
      <div class="card-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <button class="btn btn-sm btn-link toggle-card mr-2" type="button" data-target="#${collapseId}">
            <span>&#9660;</span>
          </button>
          <span>${title}</span>
        </div>
        ${icon}
      </div>
      <div id="${collapseId}" class="collapse">
        <div class="card-body">${content}</div>
      </div>
    `;
    container.appendChild(cardDiv);
    cardDiv.querySelector('.toggle-card').addEventListener('click', e => {
      document.querySelector(e.currentTarget.dataset.target).classList.toggle('collapse');
    });
  }

  async function fetchCard(option, idx) {
    const url = `{% url 'BigBrother:load_card' %}?option=${encodeURIComponent(option)}&index=${idx}`;
    const res = await fetch(url);
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || `Card ${idx+1} failed`);
    return data;
  }

  async function loadSuspicious(option) {
    showContract('Loading suspicious contracts… this may take a while', 'info');

    const listUrl  = `{% url 'BigBrother:list_contract_ids' %}?option=${encodeURIComponent(option)}`;
    const batchUrl = `{% url 'BigBrother:check_contract_batch' %}`;

    const listRes = await fetch(listUrl);
    if (!listRes.ok) throw new Error('Failed to list contracts');
    const { contracts } = await listRes.json();

    let checked = 0, hostile = [], total = contracts.length;
    const BATCH = 10;
    while (checked < total) {
      const url = `${batchUrl}?option=${encodeURIComponent(option)}&start=${checked}&limit=${BATCH}`;
      const batchRes = await fetch(url);
      const { checked: cnt, hostile_found } = await batchRes.json();
      hostile.push(...hostile_found);
      checked += cnt;
      showContract(`Checked ${checked}/${total} contracts, hostile so far: ${hostile.length}`, 'info');
    }

    hideContract();

    const hidden = new Set([
      'contract_id','assignee_id','issuer_id',
      'assignee_alliance_id','assignee_corporation_id',
      'issuer_alliance_id','issuer_corporation_id'
    ]);
     const headers = Object.keys(hostile[0] || {})
     .filter(k => k !== 'cell_styles');
   let table = '<table class="table table-striped"><thead><tr>';
   headers.forEach(h => {
     table += `<th>${h.replace(/_/g, ' ')}</th>`;
   });
   table += '</tr></thead><tbody>';
   hostile.forEach(r => {
     table += '<tr>';
     headers.forEach(col => {
       const style = r.cell_styles[col] || '';
       const val   = r[col] != null ? r[col] : '';
       table += style
         ? `<td style="${style}">${val}</td>`
         : `<td>${val}</td>`;
     });
     table += '</tr>';
   });
   table += '</tbody></table>';

    return { content: table, status: hostile.length === 0 };
  }

    // New: load & render hostile mails via streaming endpoint
async function loadSuspiciousMails(option, idx) {
  showContract('Loading mails…', 'info');
  const streamUrl = `{% url 'BigBrother:stream_mails' %}?option=${encodeURIComponent(option)}`;
  let hostileCount = 0, processed = 0, total = 0;

  // grab the card-body
  const cardBody = document.querySelector(`#collapse${idx} .card-body`);
  cardBody.innerHTML = `
    <table class="table table-striped">
      <thead>
        <tr>${MAIL_VISIBLE.map(h=>`<th>${h.replace(/_/g,' ')}</th>`).join('')}</tr>
      </thead>
      <tbody></tbody>
    </table>`;

  const reader = (await fetch(streamUrl)).body.getReader();
  const decoder = new TextDecoder();
  let buf = '';
  const progressRe = /Processed\s+(\d+)\/(\d+)/;

  while (true) {
    const { value, done } = await reader.read();
    if (done) break;

    buf += decoder.decode(value, { stream: true });

    // 1) Immediately extract any complete <tr>…</tr> fragments
    let match;
    const rowRe = /(<tr>[\s\S]*?<\/tr>)/;
    while ((match = buf.match(rowRe))) {
      const rowHtml = match[1];
      buf = buf.slice(match.index + rowHtml.length);

      // Only insert rows that contain a hostile style marker
      if (/style="color:\s*red/.test(rowHtml)) {
        hostileCount++;
        cardBody.querySelector('tbody')
                .insertAdjacentHTML('beforeend', rowHtml);
      }
    }

    // 2) Check for a progress update in the same chunk
    const progMatch = progressRe.exec(buf);
    if (progMatch) {
      processed = +progMatch[1];
      total     = +progMatch[2];
      showContract(
        `Checked ${processed}/${total} mails, hostile so far: ${hostileCount}`,
        'info'
      );
      // clear out anything before the progress so we don't re-read it
      buf = buf.slice(buf.indexOf(progMatch[0]) + progMatch[0].length);
    }
  }

  hideContract();
}


  async function loadAll(option) {
    container.innerHTML   = '';
    errorMessages.innerHTML = '';
    loadedNonSus          = 0;
    hideGeneral();
    hideContract();
    showSpinner(true);

    for (let i = 0; i < CARD_DEFINITIONS.length; i++) {
      const { key, title } = CARD_DEFINITIONS[i];
      try {
        let content, status;
        if (key === SUS_CONTR_KEY) {
          ({ content, status } = await loadSuspicious(option));
        }
        else if (key === 'sus_mail') {
          // 1) Render an empty card shell so #collapse{i} exists:
          renderCard(i, title, '<div class="mail-stream-placeholder"></div>', true);
          // 2) Now start streaming into that card in-place:
          await loadSuspiciousMails(option, i);
        }
        else {
          const card = await fetchCard(option, i);
          content = card.content;
          status  = card.status;
          loadedNonSus++;
          showGeneral(
            `${loadedNonSus}/${TOTAL_CARDS-2} loaded… This may take a while, do not refresh`,
            'info'
          );
        }
        renderCard(i, title, content, status);
      } catch (err) {
        renderCard(i, title, `<p>Error: ${err.message}</p>`, false);
        console.error(err);
      }
    }

    showSpinner(false);
    hideGeneral();
  }

  dropdown.addEventListener('change', () => loadAll(dropdown.value));
});
</script>
{% endblock %}
