{% extends 'aa_bb/base.html' %}
{% load i18n %}
{% load humanize %}

{% block details %}

<!-- Dropdown -->
<div class="mb-4">
  <label for="pageDropdown">{% translate "Select Account" %}</label>
  <select id="pageDropdown" class="form-control">
    <option value="" disabled selected>-- Choose an account --</option>
    {% for option in dropdown_options %}
      <option value="{{ option }}">{{ option }}</option>
    {% endfor %}
  </select>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="text-center mb-4" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="sr-only">Loading...</span>
  </div>
</div>

<!-- Error / Info Message -->
<div id="messageBox" class="alert" style="display: none;"></div>
<div id="contractMessage" class="alert" style="display:none;"></div>
<div id="errorMessages"></div>

<!-- Cards Container -->
<div id="cardsContainer"></div>

{% endblock %}

{% block extra_javascript %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const CARD_DEFINITIONS = [
    {% for card in CARD_DEFINITIONS %}
      { title: `{{ card.title|escapejs }}`, key: `{{ card.key }}` }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  const dropdown         = document.getElementById('pageDropdown');
  const container        = document.getElementById('cardsContainer');
  const spinner          = document.getElementById('loadingSpinner');
  const generalMessage   = document.getElementById('messageBox');
  const contractMessage  = document.getElementById('contractMessage');  // second box
  const errorMessages    = document.getElementById('errorMessages');
  const MAIL_KEYWORDS = {{ MAIL_KEYWORDS|default:"[]" }};
  const MAIL_VISIBLE = [
    "sent_date", "subject",
    "sender_name", "sender_corporation", "sender_alliance",
    "recipient_names", "recipient_corps", "recipient_alliances", "status"
  ];
  const TOTAL_CARDS      = CARD_DEFINITIONS.length;
  const SUS_CONTR_KEY    = 'sus_contr';
  let loadedNonSus       = 0;

  function showSpinner(on) {
    spinner.style.display = on ? 'block' : 'none';
  }
  function showGeneral(msg, type='info') {
    generalMessage.innerHTML    = msg;
    generalMessage.className    = 'alert alert-' + type;
    generalMessage.style.display = 'block';
  }
  function hideGeneral() {
    generalMessage.style.display = 'none';
  }
  function showContract(msg, type='info') {
    contractMessage.innerHTML    = msg;
    contractMessage.className    = 'alert alert-' + type;
    contractMessage.style.display = 'block';
  }
  function hideContract() {
    contractMessage.style.display = 'none';
  }

function renderCard(idx, title, content, status) {
  const collapseId = `collapse${idx}`;
  const cardId     = `card${idx}`;           // NEW
  const icon = status
    ? '<span class="text-success">&#128994;</span>'
    : '<span class="text-danger">&#128681;</span>';
  const cardDiv = document.createElement('div');
  cardDiv.id        = cardId;                // NEW
  cardDiv.className = 'card mb-2';
  cardDiv.innerHTML = `
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <button class="btn btn-sm btn-link toggle-card mr-2" type="button" data-target="#${collapseId}">
          <span>&#9660;</span>
        </button>
        <span>${title}</span>
      </div>
      ${icon}
    </div>
    <div id="${collapseId}" class="collapse">
      <div class="card-body">${content}</div>
    </div>
  `;
  container.appendChild(cardDiv);
  cardDiv.querySelector('.toggle-card').addEventListener('click', e => {
    document.querySelector(e.currentTarget.dataset.target).classList.toggle('collapse');
  });
}

  async function fetchCard(option, idx) {
    const url = `{% url 'BigBrother:load_card' %}?option=${encodeURIComponent(option)}&index=${idx}`;
    const res = await fetch(url);
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || `Card ${idx+1} failed`);
    return data;
  }

async function loadSuspiciousContracts(option, idx) {
  showContract('Loading suspicious contracts…', 'info');

  // Prepare the card body with an empty table
  const cardBody = document.querySelector(`#collapse${idx} .card-body`);
  cardBody.innerHTML = `
    <table class="table table-striped">
      <thead><tr id="contracts-header"></tr></thead>
      <tbody id="contracts-body"></tbody>
    </table>
  `;

  return new Promise((resolve, reject) => {
    const source = new EventSource(
      `{% url 'BigBrother:stream_contracts_sse' %}?option=${encodeURIComponent(option)}`
    );
    const thead = cardBody.querySelector('#contracts-header');
    const tbody = cardBody.querySelector('#contracts-body');
    let hostileCount = 0;

    source.addEventListener('header', e => {
      // Set up column headers
      thead.innerHTML = JSON.parse(e.data);
    });

    source.addEventListener('contract', e => {
      // Add each hostile contract row
      tbody.insertAdjacentHTML('beforeend', JSON.parse(e.data));
      hostileCount++;
      // Flip icon red on first hostile
      if (hostileCount === 1) {
        updateCardStatus(idx, false);
      }
    });

    source.addEventListener('progress', e => {
      const [processed, total] = e.data.split(',').map(Number);
      showContract(
        `Checked ${processed}/${total} contracts, hostile so far: ${hostileCount}`,
        'info'
      );
    });

    source.addEventListener('done', () => {
      source.close();
      hideContract();
      // If none hostile, ensure green
      if (hostileCount === 0) {
        updateCardStatus(idx, true);
      }
      resolve();
    });

    source.onerror = err => {
      source.close();
      const errorMessages = document.getElementById('errorMessages');
      errorMessages.innerHTML = '<div class="alert alert-warning">Contract stream failed, wait a minute for pre fetch to finish and load the page again.</div>';
      updateCardStatus(idx, true);
      reject(err);
    };
  });
}



    // New: load & render hostile mails via streaming endpoint
async function loadSuspiciousMails(option, idx) {
  showContract('Loading mails…', 'info');

  const cardBody = document.querySelector(`#collapse${idx} .card-body`);
  cardBody.innerHTML = `
    <table class="table table-striped">
      <thead>
        <tr>${MAIL_VISIBLE.map(h=>`<th>${h.replace(/_/g,' ')}</th>`).join('')}</tr>
      </thead>
      <tbody></tbody>
    </table>`;

  return new Promise((resolve, reject) => {
    const source = new EventSource(
      `{% url 'BigBrother:stream_mails_sse' %}?option=${encodeURIComponent(option)}`
    );
    const tbody = cardBody.querySelector('tbody');
    let hostileCount = 0;

    source.addEventListener('mail', e => {
      // Insert the hostile row
      tbody.insertAdjacentHTML('beforeend', JSON.parse(e.data));

      hostileCount++;
      // On first hostile mail, immediately flip the icon red
      if (hostileCount === 1) {
        updateCardStatus(idx, false);
      }
    });

    source.addEventListener('progress', e => {
      const [processed, total] = e.data.split(',').map(Number);
      showContract(
        `Checked ${processed}/${total} mails, hostile so far: ${hostileCount}`,
        'info'
      );
    });

    source.addEventListener('done', () => {
      source.close();
      hideContract();
      // If we never saw any hostile, ensure the icon is green
      if (hostileCount === 0) {
        updateCardStatus(idx, true);
      }
      resolve();
    });

    source.onerror = err => {
      source.close();
      const errorMessages = document.getElementById('errorMessages');
      errorMessages.innerHTML = '<div class="alert alert-warning">Mail stream failed, wait a minute for pre fetch to finish and load the page again.</div>';
      updateCardStatus(idx, true);
      reject(err);
    };
  });
}


function updateCardStatus(idx, isClean) {
  const cardEl    = document.getElementById(`card${idx}`);
  const header    = cardEl.querySelector('.card-header');
  header.querySelectorAll('span.text-success, span.text-danger')
        .forEach(el => el.remove());
  header.insertAdjacentHTML('beforeend',
    isClean
      ? '<span class="text-success">&#128994;</span>'
      : '<span class="text-danger">&#128681;</span>'
  );
}



async function loadAll(option) {
  container.innerHTML     = '';
  errorMessages.innerHTML = '';
  loadedNonSus            = 0;
  hideGeneral();
  hideContract();
  showSpinner(true);
  fetch("{% url 'BigBrother:warm_cache' %}?option=" + encodeURIComponent(option));

  for (let i = 0; i < CARD_DEFINITIONS.length; i++) {
    const { key, title } = CARD_DEFINITIONS[i];

    try {
      if (key === SUS_CONTR_KEY) {
        // 1) Render the card with an empty contracts table:
        renderCard(i, title,
          `<table class="table table-striped">
             <thead><tr id="contracts-header"></tr></thead>
             <tbody id="contracts-body"></tbody>
           </table>`,
          true // assume clean until we see a hostile contract
        );

        // 2) Stream the contracts; returns allClean flag
        const allClean = await loadSuspiciousContracts(option, i);

        // 3) Update dot color based on whether any hostile were found
        updateCardStatus(i, allClean);
        loadedNonSus++;
        showGeneral(
          `${loadedNonSus}/${TOTAL_CARDS} loaded… This may take a while, do not refresh`,
          'info'
        );
      }
      else if (key === 'sus_mail') {
        // Suspicious Mails
        renderCard(i, title,
          `<table class="table table-striped">
             <thead><tr>${MAIL_VISIBLE.map(h=>`<th>${h.replace(/_/g,' ')}</th>`).join('')}</tr></thead>
             <tbody></tbody>
           </table>`,
          true
        );

        // stream; allClean = true if no hostile found
        const allClean = await loadSuspiciousMails(option, i);

        // update the dot color
        updateCardStatus(i, allClean);
        loadedNonSus++;
        showGeneral(
          `${loadedNonSus}/${TOTAL_CARDS} loaded… This may take a while, do not refresh`,
          'info'
        );
      }
      else {
        // everything else
        const { content, status } = await fetchCard(option, i);
        loadedNonSus++;
        showGeneral(
          `${loadedNonSus}/${TOTAL_CARDS} loaded… This may take a while, do not refresh`,
          'info'
        );
        renderCard(i, title, content, status);
      }
    } catch (err) {
      renderCard(i, title, `<p>Error: ${err.message}</p>`, false);
      console.error(err);
    }
  }

  showSpinner(false);
  hideGeneral();
}


  dropdown.addEventListener('change', () => loadAll(dropdown.value));
});
</script>
{% endblock %}
