{% extends 'aa_bb/base.html' %}
{% load i18n %}
{% load humanize %}

{% block details %}

<!-- Dropdown -->
<div class="mb-4">
    <label for="pageDropdown">{% translate "Select Account" %}</label>
    <select id="pageDropdown" class="form-control">
        <option value="" disabled selected>-- Choose an account --</option>
        {% for option in dropdown_options %}
            <option value="{{ option }}">{{ option }}</option>
        {% endfor %}
    </select>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="text-center mb-4" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>

<!-- Error / Info Message -->
<div id="messageBox" class="alert" style="display: none;"></div>

<!-- Persistent Error Messages -->
<div id="errorMessages"></div>

<!-- Cards Container -->
<div id="cardsContainer"></div>

{% endblock %}

{% block extra_javascript %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const dropdown      = document.getElementById("pageDropdown");
  const container     = document.getElementById("cardsContainer");
  const spinner       = document.getElementById("loadingSpinner");
  const messageBox    = document.getElementById("messageBox");
  const errorMessages = document.getElementById("errorMessages");

  const TOTAL_CARDS       = 12;
  const SUS_CONTR_INDEX   = 5;  // zero‐based index for 'sus_contr'
  const STREAM_URL        = `{% url 'BigBrother:stream_contracts' %}`;

  function showSpinner(on) {
    spinner.style.display = on ? "block" : "none";
  }
  function showMessage(text, type="info") {
    messageBox.innerHTML = text;
    messageBox.className   = "alert alert-" + type;
    messageBox.style.display = "block";
  }
  function hideMessage()    { messageBox.style.display = "none"; }

  async function loadCard(option, index) {
    // 1) If Suspicious Contracts, stream HTML
    if (index === SUS_CONTR_INDEX) {
      const url = `${STREAM_URL}?option=${encodeURIComponent(option)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Stream failed: ${res.status}`);
      const htmlContent = await res.text();                // read as text :contentReference[oaicite:2]{index=2}
      // Determine status by presence of any red styling
      const status = !htmlContent.includes('style="color: red;');
      return {
        title:   'Suspicious Contracts',
        content: htmlContent,
        status
      };
    }

    // 2) Otherwise, JSON endpoint
    const url = `{% url 'BigBrother:load_card' %}`
              + `?option=${encodeURIComponent(option)}&index=${index}`;
    const res  = await fetch(url);
    const data = await res.json();                        // parse JSON :contentReference[oaicite:3]{index=3}
    if (!res.ok) throw new Error(data.error || `Card ${index+1} failed`);
    return data;
  }

  async function loadAllCards(option) {
    showSpinner(true);
    container.innerHTML  = "";
    errorMessages.innerHTML = "";
    hideMessage();

    let loaded = 0;
    for (let i = 0; i < TOTAL_CARDS; i++) {
      try {
        const card = await loadCard(option, i);
        // Build the card…
        const collapseId = `collapse${i}`;
        const icon = card.status
          ? '<span class="text-success">&#128994;</span>'
          : '<span class="text-danger">&#128681;</span>';

        const cardDiv = document.createElement("div");
        cardDiv.className = "card mb-2";
        cardDiv.innerHTML = `
          <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <button class="btn btn-sm btn-link toggle-card mr-2"
                      type="button" data-target="#${collapseId}">
                <span>&#9660;</span>
              </button>
              <span>${card.title}</span>
            </div>
            ${icon}
          </div>
          <div id="${collapseId}" class="collapse">
            <div class="card-body">${card.content}</div>
          </div>
        `;
        container.appendChild(cardDiv);
        cardDiv.querySelector(".toggle-card")
               .addEventListener("click", e =>
                 document.querySelector(e.currentTarget.dataset.target)
                         .classList.toggle("collapse")
               );

        loaded++;
        showMessage(`${loaded}/${TOTAL_CARDS} loaded…`, "info");
      } catch (err) {
        console.error(err);
        const d = document.createElement("div");
        d.className = "alert alert-danger";
        d.innerText = `Error loading card ${i+1}: ${err.message}`;
        errorMessages.appendChild(d);
      }
    }

    showSpinner(false);
    if (loaded === 0) {
      showMessage("No cards could be loaded.", "warning");
    } else {
      hideMessage();
    }
  }

  dropdown.addEventListener("change", () => {
    loadAllCards(dropdown.value);
  });
});
</script>
{% endblock %}
